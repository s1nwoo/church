<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„±ê²½ íƒ€ì ì—°ìŠµ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #verseContainer span {
            font-weight: bold;
        }
    </style>
</head>
<body class="container py-5">

<!-- âœ… CSRF í† í° ìˆ¨ê¹€ í•„ë“œ (Ajaxìš©) -->
<input type="hidden" id="_csrf" th:value="${_csrf.token}" th:name="${_csrf.parameterName}" />

<h4 class="mb-3" id="currentKey" th:text="${currentKey}">ì°½1:1</h4>

<!-- âœ… ì˜¤íƒ€ í•˜ì´ë¼ì´íŠ¸ìš© div -->
<div id="verseContainer" class="mb-3" style="font-size: 1.2rem; font-weight: 500;">
    ì •ë‹µ êµ¬ì ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
</div>

<!-- âœ… ìˆ¨ê²¨ì§„ êµ¬ì ˆ í…ìŠ¤íŠ¸ ì „ë‹¬ -->
<div id="correctText" th:text="${verseText}" style="display: none;"></div>

<!-- âœ… ì‚¬ìš©ì ì…ë ¥ -->
<input type="text" name="typedText" id="typedText" class="form-control" placeholder="ë³¸ë¬¸ì„ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”" required>

<!-- âœ… ë‹¤ìŒ êµ¬ì ˆ ë²„íŠ¼ (Ajaxë¡œ ì²˜ë¦¬) -->
<button type="button" id="nextBtn" class="btn btn-primary mt-3" disabled>ë‹¤ìŒ êµ¬ì ˆë¡œ</button>

<p class="mt-2">
    ì§„í–‰í˜„í™©: <span id="progressStatus" th:text="${currentIndex} + '/' + ${totalCount}">0/0</span>
</p>

<!-- âœ… ì¶•í•˜ ë©”ì‹œì§€ -->
<div id="congratsMessage" class="alert alert-success mt-3" style="display:none;">
    ğŸ‰ ëª¨ë“  êµ¬ì ˆì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤ ğŸ‰
</div>

<script>
    const inputBox = document.getElementById('typedText');
    const nextBtn = document.getElementById('nextBtn');
    const verseContainer = document.getElementById('verseContainer');
    const currentKeyLabel = document.getElementById('currentKey');
    let correctText = document.getElementById('correctText').innerText;
    const progressBar = document.getElementById('progressBar');
    const remainingCount = document.getElementById('remainingCount');
    const congratsMessage = document.getElementById('congratsMessage');
    const csrfToken = document.getElementById('_csrf').value;

    // âœ… í˜ì´ì§€ ì²˜ìŒ ë¡œë”© ì‹œ êµ¬ì ˆ í‘œì‹œ
    window.addEventListener('DOMContentLoaded', () => {
        console.log("ì •ë‹µ êµ¬ì ˆ:", correctText); // ì½˜ì†”ì—ì„œ í™•ì¸ìš©
        verseContainer.textContent = correctText;
    });

    function normalize(text) {
        return text.normalize('NFC').trim();
    }

    function checkTyping() {
        const typed = normalize(inputBox.value);
        const original = normalize(correctText);

        let resultHTML = "";
        let isCorrect = true;

        for (let i = 0; i < original.length; i++) {
            const correctChar = original[i];
            const typedChar = typed[i];

            if (typedChar === undefined) {
                resultHTML += `<span style="color:red;">${correctChar}</span>`;
                isCorrect = false;
            } else if (typedChar === correctChar) {
                resultHTML += `<span>${correctChar}</span>`;
            } else {
                resultHTML += `<span style="color:red;">${correctChar}</span>`;
                isCorrect = false;
            }
        }

        verseContainer.innerHTML = resultHTML;
        nextBtn.disabled = !isCorrect;
    }

    inputBox.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            checkTyping();
        }
    });
    inputBox.addEventListener('focusout', checkTyping);

    nextBtn.addEventListener('click', () => {
        fetch('/reading/next-ajax', {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': csrfToken
            }
        })
        .then(res => res.json())
        .then(data => {
            correctText = data.verseText;
            document.getElementById('correctText').innerText = correctText;
            currentKeyLabel.innerText = data.currentKey;
            inputBox.value = "";
            verseContainer.textContent = correctText;

            // âœ… ì§„í–‰í˜„í™© í…ìŠ¤íŠ¸ ë™ì  ì—…ë°ì´íŠ¸
            document.getElementById('progressStatus').textContent = data.currentIndex + '/' + data.totalCount;

            if (data.isFinished) {
                congratsMessage.style.display = "block";
                nextBtn.disabled = true;
            } else {
                congratsMessage.style.display = "none";
                nextBtn.disabled = true;
            }
        });
    });
</script>


</body>
</html>
